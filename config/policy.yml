version: 1
enabled: true

capabilities:
  - alerts.explain
  - alerts.strategy
  - alerts.query
  - ops.status
  - ops.logs
  - ops.ps

default:
  allow: []
  rate_limit:
    rpm: 30
  output_limits:
    max_lines: 60
    max_chars: 6000

rules:
  # 0) Owner strategy anywhere (avoid chat_id mismatch blocking)
  - name: owner_strategy_any
    match:
      channel: telegram
      user_id: "1864053991"
      capability: "alerts.strategy"
    allow:
      - alerts.strategy
    require:
      mention_bot_for_explain: false
      reply_required_for_explain: false
      mention_bot_for_ops: false

  # 1) Owner DM: explain + ops (Phase A)
  - name: owner_dm_all
    match:
      channel: telegram
      chat_type: private
      user_id: "1864053991"
    allow:
      - alerts.explain
      - alerts.strategy
      - alerts.query
      - ops.status
      - ops.logs
      - ops.ps
    require:
      mention_bot_for_explain: false
      reply_required_for_explain: false
      mention_bot_for_ops: false
    rate_limit:
      rpm: 60
    output_limits:
      max_lines: 120
      max_chars: 9000

  # 2) Project group: owner can use ops; explain must @ + reply
  - name: crypto_agent_group_owner
    match:
      channel: telegram
      chat_id: "-5242302064"
      chat_type: group
      user_id: "1864053991"
    allow:
      - alerts.explain
      - alerts.strategy
      - alerts.query
      - ops.status
      - ops.logs
      - ops.ps
    require:
      mention_bot_for_explain: true
      reply_required_for_explain: true
      mention_bot_for_ops: false
    rate_limit:
      rpm: 30
    output_limits:
      max_lines: 80
      max_chars: 8000

  # 3) Project group: non-owner deny (with message)
  - name: crypto_agent_group_non_owner_deny
    match:
      channel: telegram
      chat_id: "-5242302064"
      chat_type: group
    allow: []
    deny_message: "ğŸš« æœªæˆæƒæ“ä½œ\næœ¬ç¾¤ Bot ä»…å¯¹é¡¹ç›® Owner å¼€æ”¾è§£é‡Šèƒ½åŠ›ã€‚"

  # 4) Feishu owner DM
  - name: feishu_owner_dm_all
    match:
      channel: feishu
      chat_type: private
      user_id: "NL"
    allow:
      - alerts.explain
      - ops.status
      - ops.logs
      - ops.ps
    require:
      mention_bot_for_explain: false
      reply_required_for_explain: false
      mention_bot_for_ops: false
    rate_limit:
      rpm: 60
    output_limits:
      max_lines: 120
      max_chars: 9000

  # 5) Feishu group: owner allow (explain requires @ + reply)
  - name: feishu_group_owner
    match:
      channel: feishu
      chat_id: "oc_d69f1c419652e849c85e6d15cf467c2f"
      chat_type: group
      user_id: "NL"
    allow:
      - alerts.explain
      - ops.status
      - ops.logs
      - ops.ps
    require:
      mention_bot_for_explain: true
      reply_required_for_explain: true
      mention_bot_for_ops: false
    rate_limit:
      rpm: 30
    output_limits:
      max_lines: 80
      max_chars: 8000

  # 6) Feishu group: non-owner deny (with message)
  - name: feishu_group_non_owner_deny
    match:
      channel: feishu
      chat_id: "oc_d69f1c419652e849c85e6d15cf467c2f"
      chat_type: group
    allow: []
    deny_message: "ğŸš« æœªæˆæƒæ“ä½œ\næœ¬ç¾¤ Bot ä»…å¯¹é¡¹ç›® Owner å¼€æ”¾è§£é‡Šèƒ½åŠ›ã€‚"
